# AWS - S3

[Back](../index.md)

- [AWS - S3](#aws---s3)
  - [Amazon S3](#amazon-s3)
    - [Buckets](#buckets)
    - [Objects](#objects)
    - [Durability and Availability](#durability-and-availability)
    - [Hands-on](#hands-on)
  - [S3 Storage Classes](#s3-storage-classes)
    - [S3 Standard – General Purpose](#s3-standard--general-purpose)
    - [Infrequent Access](#infrequent-access)
    - [Glacier Storage Classes](#glacier-storage-classes)
    - [Intelligent-Tiering](#intelligent-tiering)
    - [Comparison](#comparison)
    - [Hands-on](#hands-on-1)
  - [Security](#security)
    - [Bucket Policies](#bucket-policies)
    - [Block Public Access](#block-public-access)
    - [Hands-On](#hands-on-2)
  - [Static Website Hosting](#static-website-hosting)
    - [Hands-on](#hands-on-3)
  - [Versioning](#versioning)
    - [Hands-on](#hands-on-4)
  - [Replication (CRR \& SRR)](#replication-crr--srr)
    - [Hands-on](#hands-on-5)

---

## Amazon S3

- **Use cases**

  - Backup and storage
  - Disaster Recovery
  - Archive
  - Hybrid Cloud storage
  - Application hosting
  - Media hosting
  - Data lakes & big data analytics
  - Software delivery
  - Static website

---

### Buckets

- `Buckets`

  - as top level directories

- Bucket name:

  - must have a **globally unique** name (across all regions all accounts)
  - Naming convention
    - No uppercase, **No underscore**
    - 3-63 characters long
    - Not an IP
    - Must start with lowercase letter or number
    - Must NOT start with the prefix `xn--`
    - Must NOT end with the suffix `-s3alias`

- S3 looks like a global service but buckets are created in a region

  - Bucket **names** are defined in **golbal** level
  - **Buckets** are defined at the **region** level

---

### Objects

- `Objects`

  - the files stored in S3 buckets
  - Objects (files) have a **Key**

- `key`:

  - the FULL path of objects:

    - `s3://my-bucket/my_file.txt`
    - `s3://my-bucket/my_folder1/another_folder/my_file.txt`

  - There’s no concept of “directories” within buckets (although the UI will trick you to think otherwise)
  - Just keys with very long names that contain slashes (“/”)

  - composed of **prefix** + **object name**

![s3_object_key](./pic/s3_object_key.png)

- `Object value`

  - the content of the body
  - Max. Object Size is `5TB` (5000GB)
  - If uploading **more than 5GB**, must use **“multi-part upload”**
    - Multi-Part Upload is **recommended** as soon as the file is over `100 MB`.

- `Metadata`

  - list of text key / value pairs
  - system or user metadata

- `Tags`
  - Unicode key / value pair
  - up to `10`
  - useful for security / lifecycle
- `Version ID`
  - if versioning is enabled

---

### Durability and Availability

- **Durability:**

  - High durability (99.999999999%, 11 9’s) of objects across multiple AZ
  - If you store 10,000,000 objects with Amazon S3, you can on average expect to incur a **loss** of a single object once every 10,000 years
  - **Same** for all storage classes

- **Availability:**
  - Measures how **readily available** a service is
  - **Varies** depending on storage class
    - Example: S3 standard has 99.99% availability = not available 53 minutes a year

---

### Hands-on

- Create bucket

![s3_bucket_handson01](./pic/s3_bucket_handson01.png)

- Upload file

![s3_bucket_handson01](./pic/s3_bucket_handson02.png)

![s3_bucket_handson01](./pic/s3_bucket_handson03.png)

- Create folder

![s3_bucket_handson01](./pic/s3_bucket_handson04.png)

---

## S3 Storage Classes

### S3 Standard – General Purpose

- Used for **frequently accessed data**
- 99.99% Availability
- **Low latency** and high throughput
- Sustain 2 concurrent facility failures
- **Use Cases**:
  - Big Data analytics
  - mobile & gaming applications
  - content distribution…

---

### Infrequent Access

- For data that is **less frequently accessed**, but requires rapid access when needed
- Lower cost than S3 Standard

- **Amazon S3 Standard-Infrequent Access (S3 Standard-IA)**

  - 99.9% Availability
  - Use cases:
    - Disaster **Recovery**,
    - **backups**

- **Amazon S3 One Zone-Infrequent Access (S3 One Zone-IA)**
  - High durability (99.999999999%) in a **single AZ**;
  - data **lost** when AZ is **destroyed**
  - 99.5% Availability
  - Use Cases:
    - Storing **secondary backup** copies of on-premises data, or data you can recreate

---

### Glacier Storage Classes

- **Low-cost** object storage meant for **archiving / backup**
- Pricing: price for **storage** + object **retrieval** cost

- **Amazon S3 Glacier Instant Retrieval**

  - Millisecond retrieval, great for data **accessed once a quarter**
  - Minimum storage duration of **90 days**

- **Amazon S3 Glacier Flexible Retrieval (formerly Amazon S3 Glacier):**

  - Types:
    - Expedited (1 to 5 minutes),
    - Standard (3 to 5 hours),
    - **Bulk** (5 to 12 hours) – **free**
  - Minimum storage duration of **90 days**

- **Amazon S3 Glacier Deep Archive – for long term storage:**
  - Standard (12 hours),
  - Bulk (48 hours)
  - Minimum storage duration of **180 day**

---

### Intelligent-Tiering

- Small **monthly monitoring** and auto-tiering fee
- Moves objects **automatically** between Access Tiers based on usage

- There are **no retrieval** charges in S3 Intelligent-Tiering
  - **Frequent** Access tier (automatic): **default** tier
  - **Infrequent** Access tier (automatic): objects not accessed for **30 days**
  - **Archive Instant** Access tier (automatic): objects not accessed for **90 days**
  - **Archive** Access tier (optional): configurable from 90 days to **700+** days
  - **Deep Archive** Access tier (optional): config. from **180** days to **700+** days

---

### Comparison

![s3_storage_class_comparison](./pic/s3_storage_class_comparison.png)

![s3_storage_price_comparison](./pic/s3_storage_price_comparison.png)

---

### Hands-on

- Upload file and select storage class.

![s3_storage_class_handson01](./pic/s3_storage_class_handson01.png)

![s3_storage_class_handson01](./pic/s3_storage_class_handson02.png)

- Create lifecycle rule

![s3_storage_class_handson01](./pic/s3_storage_class_handson03.png)

![s3_storage_class_handson01](./pic/s3_storage_class_handson04.png)

---

## Security

- **User-Based**

  - **IAM Policies**
    - which API calls should be **allowed for a specific user** from IAM

![s3_iam_permission_user_access_diagram](./pic/s3_iam_permission_user_access_diagram.png)

![s3_iam_role_ec2_access_diagram](./pic/s3_iam_role_ec2_access_diagram.png)

- **Resource-Based**

  - **Bucket Policies**
    - bucket wide rules from the S3 console
    - allows cross account

![s3_bucket_policy_public_access_diagram](./pic/s3_bucket_policy_public_access_diagram.png)

![s3_bucket_policy_cross_account_access_diagram](./pic/s3_bucket_policy_cross_account_access_diagram.png)

- **Object Access Control List (ACL)**
  - finer grain (can be disabled)
- **Bucket Access Control List (ACL)**

  - less common (can be disabled)

- Note: an IAM principal **can access** an S3 object if

  - The user **IAM permissions** `ALLOW` it **OR** the **resource policy** `ALLOWS` it
  - **AND** there’s **no** explicit `DENY`
    - Explicit DENY in an IAM Policy will take precedence over an S3 bucket policy.

- **Encryption**
  - encrypt objects in Amazon S3 using encryption keys

---

### Bucket Policies

- JSON based policies

  - **Resources**:
    - buckets and objects
  - **Effect**:
    - Allow / Deny
  - **Actions**:
    - Set of API to Allow or Deny
  - **Principal**:
    - The account or user to apply the policy to

![s3_bucket_policies_sample](./pic/s3_bucket_policies_sample.png)

- Use S3 bucket for policy to:
  - Grant public access to the **bucket**
  - Force objects to be **encrypted at upload**
  - Grant access to **another account** (Cross Account)

---

### Block Public Access

![s3_public_access](./pic/s3_public_access.png)

- These settings were created to **prevent company data leaks**
- If you know your bucket should never be public, leave these on
- **Can** be set **at the account level**

---

### Hands-On

1. Disable block public access

![s3_public_access_handson01](./pic/s3_public_access_handson01.png)

![s3_public_access_handson02](./pic/s3_public_access_handson02.png)

2. Edit Bucket policy, using **Policy generator**

![s3_public_access_handson03](./pic/s3_public_access_handson03.png)

![s3_public_access_handson04](./pic/s3_public_access_handson04.png)

![s3_public_access_handson05](./pic/s3_public_access_handson05.png)

![s3_public_access_handson06](./pic/s3_public_access_handson06.png)

---

## Static Website Hosting

- S3 can **host static websites** and have them **accessible on the Internet**
- The website URL will be (depending on the region)

  - `http://bucket-name.s3-website-aws-region.amazonaws.com` OR
  - `http://bucket-name.s3-website.aws-region.amazonaws.com`

- If you get a **403 Forbidden** error, make sure the **bucket policy allows public reads**!

![s3_static_website_hosting_diagram](./pic/s3_static_website_hosting_diagram.png)

---

### Hands-on

- Enable Website hosting

![s3_static_website_hosting_handson01](./pic/s3_static_website_hosting_handson01.png)

![s3_static_website_hosting_handson02](./pic/s3_static_website_hosting_handson02.png)

- Upload web files

- Website

![s3_static_website_hosting_handson03](./pic/s3_static_website_hosting_handson03.png)

---

## Versioning

- You can version your files in Amazon S3
- It is enabled **at the bucket level**
- **Same key overwrite** will change the “version”: 1, 2, 3….

- It is best practice to version your buckets

  - Protect against unintended deletes (ability to restore a version)
  - **Easy roll back** to previous version

- Notes:
  - Any file that is **not versioned prior to** enabling versioning will have **version `null`**
  - Suspending versioning does **not delete** the previous versions

![s3_versioning_diagram](./pic/s3_versioning_diagram.png)

---

### Hands-on

- Enable versioining

![s3_versioning_handson01](./pic/s3_versioning_handson01.png)

![s3_versioning_handson02](./pic/s3_versioning_handson02.png)

- Upload files

- Website after updated

![s3_versioning_handson03](./pic/s3_versioning_handson03.png)

![s3_versioning_handson04](./pic/s3_versioning_handson04.png)

- Roll back version: delete

![s3_versioning_handson05](./pic/s3_versioning_handson05.png)

![s3_versioning_handson06](./pic/s3_versioning_handson06.png)

- Delete: not real delete, but create a delete marker.
  - Disable "show version"
  - Select file to delete
  - Enable show version

![s3_versioning_handson07](./pic/s3_versioning_handson07.png)

- Website after deleted

![s3_versioning_handson07](./pic/s3_versioning_handson08.png)

---

## Replication (CRR & SRR)

- `S3 Replication`
  - allows you to **replicate data** from an S3 bucket to another **in the same/different AWS Region**.
- **Must enable Versioning** in source and destination buckets
- `Cross-Region Replication (CRR)`
- `Same-Region Replication (SRR)`

- Buckets can be in **different AWS accounts**
- Copying is **asynchronous**
- Must give proper **IAM permissions** to S3

- **Use cases**:
  - CRR: compliance, lower latency access, replication across accounts
  - SRR: log aggregation, live replication between production and test accounts

![s3_replication_diagram](./pic/s3_replication_diagram.png)

- After you enable Replication, **only new objects** are replicated
- Optionally, you can **replicate existing objects** using `S3 Batch Replication`

  - Replicates existing objects and objects that failed replication

- For **DELETE operations**

  - Can **replicate delete markers** from source to target (**optional** setting)
  - Deletions with a version ID(Permenant deletion) are **not replicated** (to avoid malicious deletes)

- There is **no “chaining”** of replication
  - If bucket 1 has replication into bucket 2, which has replication into bucket 3
  - Then objects created in bucket 1 are not replicated to bucket 3

---

### Hands-on

- Create 2 buckets

![s3_replication_handson01](./pic/s3_replication_handson01.png)

- Upload file to original bucket

![s3_replication_handson02](./pic/s3_replication_handson02.png)

- Create replication rule

![s3_replication_handson03](./pic/s3_replication_handson03.png)

![s3_replication_handson03](./pic/s3_replication_handson04.png)

![s3_replication_handson03](./pic/s3_replication_handson05.png)

- Upload file in origin bucket

![s3_replication_handson03](./pic/s3_replication_handson06.png)

- Target bucket will update the new uploaded file.
  - the file before replication will not copy.

![s3_replication_handson03](./pic/s3_replication_handson07.png)

- It is optional to replicate Delete marker

![s3_replication_handson03](./pic/s3_replication_handson08.png)

- If origin bucket deletes a file permanently, this deletion will be replicated to the target bucket.

---

[TOP](#aws---s3)
